<!DOCTYPE html>
<html>
<head>
  <title>Leaderboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="app-shell">
  <aside class="sidebar">
    <div class="brand"><span class="brand-icon">âš™ï¸</span>TechnoForge</div>
    <nav class="side-nav">
      <a href="index.html"><span class="nav-icon">âŒ‚</span>Home</a>
      <a href="problem.html"><span class="nav-icon">ğŸ“‹</span>Problem Statement</a>
      <a href="upload.html"><span class="nav-icon">ğŸš€</span>Submissions</a>
      <a class="active" href="leaderboard.html"><span class="nav-icon">ğŸ¥‡</span>Leaderboard</a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <span class="user-avatar" id="userAvatar">T</span>
        <span class="user-name" id="userNameDisplay">Team</span>
      </div>
      <button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
    </div>
  </aside>

  <main class="main-content">
    <header style="margin-bottom:16px;text-align:center">ğŸ† Live Leaderboard</header>

    <section class="card full">
      <!-- Podium for Top 3 -->
      <div class="podium-container" id="podiumContainer">
        <div class="podium-item second" id="podium2">
          <div class="podium-medal">ğŸ¥ˆ</div>
          <div class="podium-avatar">2</div>
          <div class="podium-name">-</div>
          <div class="podium-score">-</div>
          <div class="podium-block">2</div>
        </div>
        <div class="podium-item first" id="podium1">
          <div class="podium-medal">ğŸ¥‡</div>
          <div class="podium-avatar">1</div>
          <div class="podium-name">-</div>
          <div class="podium-score">-</div>
          <div class="podium-block">1</div>
        </div>
        <div class="podium-item third" id="podium3">
          <div class="podium-medal">ğŸ¥‰</div>
          <div class="podium-avatar">3</div>
          <div class="podium-name">-</div>
          <div class="podium-score">-</div>
          <div class="podium-block">3</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;justify-content:flex-end;flex-wrap:wrap;margin-bottom:8px;margin-top:20px">
        <div style="display:flex;gap:10px;align-items:center">
          <input id="myname" placeholder="Search team name..." style="min-width:240px;padding:12px 16px;font-size:0.95rem;border-radius:10px" />
          <button onclick="findMe()" style="padding:12px 18px;font-size:0.95rem;border-radius:10px">ğŸ” Search</button>
        </div>
      </div>

      <div style="overflow:auto;margin-top:16px">
        <table class="lb-table">
          <thead>
            <tr><th class="lb-rank">Rank</th><th class="lb-name">Team Name</th><th class="lb-smape">Metric Score</th><th class="lb-time">Submitted</th></tr>
          </thead>
          <tbody id="board"></tbody>
        </table>
      </div>

      <button id="showMore" class="show-more" onclick="showMore()">Show More Teams</button>
    </section>
  </main>
</div>

<script>
// Format timestamp to readable format
function formatTimestamp(timestamp) {
  if (!timestamp || timestamp === '-') return '-';
  try {
    const date = new Date(timestamp);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
  } catch (e) {
    return timestamp;
  }
}

async function loadBoard(){
  const res = await fetch("/leaderboard");
  const data = await res.json();
  
  // Update podium for top 3
  updatePodium(data);
  
  // render as a clean table with Rank / Team / SMAPE / Timestamp
  const board = document.getElementById('board');
  board.innerHTML = '';
  const limit = window._lb_limit || 10;
  data.slice(0, limit).forEach(r=>{
    const tr = document.createElement('tr');
    tr.dataset.team = (r.user || '').toLowerCase();
    
    // Add medal for top 3
    let rankDisplay = r.rank;
    if(r.rank === 1) rankDisplay = 'ğŸ¥‡ 1';
    else if(r.rank === 2) rankDisplay = 'ğŸ¥ˆ 2';
    else if(r.rank === 3) rankDisplay = 'ğŸ¥‰ 3';
    
    tr.innerHTML = `
      <td class="lb-rank">${rankDisplay}</td>
      <td class="lb-name">${r.user}</td>
      <td class="lb-smape">${r.smape}</td>
      <td class="lb-time">${formatTimestamp(r.timestamp)}</td>`;
    board.appendChild(tr);
  });

  // update show more label with remaining count
  const moreBtn = document.getElementById('showMore');
  if(data.length > limit){
    moreBtn.innerText = `Show More Teams (${data.length - limit} more)`;
    moreBtn.classList.remove('hidden');
  } else {
    moreBtn.classList.add('hidden');
  }

  // if user previously searched, re-run highlight
  const lastQuery = document.getElementById('myname').value.trim();
  if(lastQuery) findMe();
}

function updatePodium(data) {
  const podiumContainer = document.getElementById('podiumContainer');
  
  if(data.length < 1) {
    podiumContainer.style.display = 'none';
    return;
  }
  podiumContainer.style.display = 'flex';
  
  // First place
  if(data[0]) {
    const p1 = document.getElementById('podium1');
    p1.querySelector('.podium-avatar').textContent = data[0].user.charAt(0).toUpperCase();
    p1.querySelector('.podium-name').textContent = data[0].user;
    p1.querySelector('.podium-score').textContent = data[0].smape;
  }
  
  // Second place
  if(data[1]) {
    const p2 = document.getElementById('podium2');
    p2.querySelector('.podium-avatar').textContent = data[1].user.charAt(0).toUpperCase();
    p2.querySelector('.podium-name').textContent = data[1].user;
    p2.querySelector('.podium-score').textContent = data[1].smape;
    p2.style.visibility = 'visible';
  } else {
    document.getElementById('podium2').style.visibility = 'hidden';
  }
  
  // Third place
  if(data[2]) {
    const p3 = document.getElementById('podium3');
    p3.querySelector('.podium-avatar').textContent = data[2].user.charAt(0).toUpperCase();
    p3.querySelector('.podium-name').textContent = data[2].user;
    p3.querySelector('.podium-score').textContent = data[2].smape;
    p3.style.visibility = 'visible';
  } else {
    document.getElementById('podium3').style.visibility = 'hidden';
  }
}

function resetBoard(){
  if(confirm("Reset leaderboard?")){
    fetch("/leaderboard/reset",{method:"POST"}).then(()=>loadBoard());
  }
}

function showMore(){
  window._lb_limit = (window._lb_limit || 10) + 10;
  loadBoard();
}

function findMe(){
  const name = document.getElementById('myname').value.trim().toLowerCase();
  if(!name) return alert('Enter a team name');
  // find using substring match and highlight the first match
  const rows = Array.from(document.querySelectorAll('#board tr'));
  rows.forEach(r=>r.classList.remove('highlight'));
  const found = rows.find(r => r.dataset.team && r.dataset.team.includes(name));
  if(found){
    found.classList.add('highlight');
    // scroll into view within container
    found.scrollIntoView({behavior:'smooth',block:'center'});
  } else {
    alert('Team not found in leaderboard');
  }
}

function highlightTeam(name, data){
  const found = data.find(d=>d.user.toLowerCase()===name.toLowerCase());
  const pos = document.getElementById('your-position');
  if(found){
    pos.classList.remove('hidden');
    pos.innerHTML = `
      <div class="avatar">${found.user.slice(0,1).toUpperCase()}</div>
      <div style="flex:1">
        <div style="font-weight:700">${found.user} <small style="opacity:.8">(You)</small></div>
        <div style="font-size:.9rem;color:rgba(255,255,255,.8)">Rank #${found.rank} â€¢ ${found.timestamp}</div>
      </div>
      <div style="font-weight:800">${found.smape}</div>`;
    // scroll to top to make sure it's visible
    window.scrollTo({top: document.body.scrollHeight - 200, behavior: 'smooth'});
  } else {
    pos.classList.add('hidden');
    alert('Team not found in leaderboard');
  }
}

loadBoard();
setInterval(loadBoard, 5000); // LIVE refresh

// search on Enter key
document.getElementById('myname').addEventListener('keydown', function(e){
  if(e.key === 'Enter') findMe();
});

// Auth check via database
(async function() {
  try {
    const res = await fetch('/auth/me');
    const data = await res.json();
    
    if (!data.authenticated) {
      window.location.href = 'login.html';
      return;
    }
    
    // Update user info in sidebar
    document.getElementById('userNameDisplay').textContent = data.team_name;
    document.getElementById('userAvatar').textContent = data.team_name.charAt(0).toUpperCase();
  } catch (e) {
    window.location.href = 'login.html';
  }
})();

async function logout() {
  await fetch('/auth/logout', { method: 'POST', credentials: 'same-origin' });
  window.location.href = 'login.html';
}
</script>
</body>
</html>
